# This server block handles redirecting all standard HTTP traffic to HTTPS.
server {
    listen 80;
    server_name localhost; # Replace with your domain if you have one

    # Redirect all HTTP requests to the secure HTTPS version of the site.
    return 301 https://$host$request_uri;
}

# This is the main server block that handles all secure application traffic.
server {
    listen 443 ssl;
    server_name localhost; # Replace with your domain if you have one

    # --- SSL Certificate Configuration ---
    # These paths point to the certificates mounted into the container via docker-compose.
    ssl_certificate /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;

    # --- Location Blocks for Frontend Services ---
    # These blocks route traffic to your user-facing pages.

    # Default route for the main landing page
    location / {
        proxy_pass http://frontend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Route for the User Portal
    location /portal/ {
        proxy_pass http://user-portal-service:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Route for the Admin Portal
    location /admin/ {
        proxy_pass http://admin-portal-service:5003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Route for the Event Registration Service (ERS)
    location /register {
        proxy_pass http://event_registration_service:5006;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Location Blocks for Backend APIs ---
    # These blocks route API calls to the correct microservice.
    
    # Auth Service API
    location /auth/ {
        proxy_pass http://auth_api:5002;
    }

    # User DB API
    location /api/users/ {
        proxy_pass http://db_api:5004;
    }

    # Event Service API
    location /api/events/ {
        proxy_pass http://event-service:5000;
    }

    # Participation Service API
    location /participant-records/ {
        proxy_pass http://participation_service:5005;
    }

    # --- Location Block for Static Files ---
    # This block is important for serving CSS, JS, and image files correctly.
    location /static/ {
        # Sets an alias to look for static files in a common directory,
        # assuming you have a volume mount for static assets.
        # This part may need adjustment based on your exact static file strategy.
        alias /app/static/;
        expires 1d;
    }
}
