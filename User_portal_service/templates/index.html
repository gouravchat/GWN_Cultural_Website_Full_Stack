<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Portal - Event Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sidebar-icon { width: 20px; height: 20px; stroke-width: 2; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.75rem; /* 12px */
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); width: 90%; max-width: 700px; /* Increased max-width */
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .required-asterisk::after { content: ' *'; color: red; }
        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;
        }
        .toast-message {
            padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white; opacity: 0; transform: translateX(100%); animation: toast-in 0.5s forwards;
        }
        .toast-message.success { background-color: #22c55e; } /* green-500 */
        .toast-message.error { background-color: #ef4444; } /* red-500 */
        .toast-message.info { background-color: #3b82f6; } /* blue-500 */
        @keyframes toast-in {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toast-out {
            to { opacity: 0; transform: translateX(100%); }
        }
        .form-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .form-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .form-grid label, .modal-content label { display: block; font-weight: 500; margin-bottom: 0.25rem; font-size: 0.875rem; color: #374151; }
        .form-grid input, .form-grid select, .form-grid textarea,
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; padding: 0.65rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
            font-size: 0.875rem; transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-grid input:focus, .form-grid select:focus, .form-grid textarea:focus,
        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
            outline: none;
        }
        .info-box { background-color: #eff6ff; color: #1d4ed8; padding: 0.75rem 1rem; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem; border-left: 4px solid #3b82f6;}
        .summary-item { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.9rem;}
        .summary-item strong { color: #1f2937; }
        .total-payable-display { font-size: 1.25rem; font-weight: bold; color: #16a34a; } /* green-600 */
        .remaining-payable-display { font-size: 1rem; font-weight: 500; color: #ef4444; } /* red-500 */
    </style>
</head>
<body class="flex h-screen antialiased text-gray-900" data-user-id="{{ user_id }}"> <!-- Pass user_id from Flask template -->

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-gray-100 flex flex-col p-4 space-y-4 fixed h-full rounded-r-lg shadow-xl">
        <div class="flex items-center space-x-2 px-2 py-3 border-b border-gray-700">
            <i data-lucide="zap" class="text-indigo-400 w-7 h-7"></i>
            <h1 class="text-xl font-semibold">EventHub Portal</h1>
        </div>
        <nav class="flex-grow">
            <ul class="space-y-1">
                <li><a href="#profile" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-150" data-section="profile"><i data-lucide="user-circle-2" class="sidebar-icon"></i><span>My Profile</span></a></li>
                <li><a href="#all-events" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-150" data-section="all-events"><i data-lucide="calendar-days" class="sidebar-icon"></i><span>All Events</span></a></li>
                <li><a href="#my-participations" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-150" data-section="my-participations"><i data-lucide="clipboard-check" class="sidebar-icon"></i><span>My Participations</span></a></li>
            </ul>
        </nav>
        <div class="mt-auto border-t border-gray-700 pt-4">
            <div id="sidebarUserProfile" class="flex items-center space-x-3 px-3 py-2.5 mb-2">
                <img id="sidebarUserAvatar" src="https://placehold.co/40x40/A78BFA/FFFFFF?text=U" alt="User Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-400">
                <div>
                    <p id="sidebarUsername" class="text-sm font-medium">User Name</p>
                    <p id="sidebarUserEmail" class="text-xs text-gray-400">user@example.com</p>
                </div>
            </div>
            <button id="logoutButton" class="w-full flex items-center space-x-3 px-3 py-2.5 rounded-lg text-red-400 hover:bg-red-700 hover:text-white transition-colors duration-150">
                <i data-lucide="log-out" class="sidebar-icon"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 ml-64 p-6 md:p-8 lg:p-10 overflow-y-auto">
        <!-- Profile Section -->
        <section id="profile" class="content-section mb-10">
            <header class="mb-6">
                <h2 class="text-3xl font-semibold text-gray-800">My Profile</h2>
            </header>
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <div id="profileDisplay" class="space-y-4">
                    <p><strong>Username:</strong> <span id="profileUsername" class="text-gray-700">Loading...</span></p>
                    <p><strong>Email:</strong> <span id="profileEmail" class="text-gray-700">Loading...</span></p>
                    <p><strong>Bio:</strong> <span id="profileBio" class="text-gray-700 block whitespace-pre-wrap">Loading...</span></p>
                    <button id="editProfileBtn" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center space-x-2">
                        <i data-lucide="edit-3" class="w-4 h-4"></i> <span>Edit Profile</span>
                    </button>
                </div>
                <form id="profileEditForm" class="hidden space-y-4">
                    <div><label for="editUsername" class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="editUsername" name="username" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                    <div><label for="editEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="editEmail" name="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                    <div><label for="editBio" class="block text-sm font-medium text-gray-700">Bio</label><textarea id="editBio" name="bio" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea></div>
                    <div class="flex space-x-3"><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 flex items-center space-x-2"><i data-lucide="save" class="w-4 h-4"></i> <span>Save Changes</span></button><button type="button" id="cancelEditBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-150">Cancel</button></div>
                </form>
            </div>
        </section>
        <!-- All Events Section -->
        <section id="all-events" class="content-section hidden mb-10">
            <header class="mb-6 flex justify-between items-center"><h2 class="text-3xl font-semibold text-gray-800">All Upcoming Events</h2><button id="refreshAllEventsBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 flex items-center space-x-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>Refresh Events</span></button></header>
            <div id="allEventsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <p id="noAllEventsMessage" class="hidden mt-4 text-gray-600">No upcoming events found. Check back later!</p>
        </section>
        <!-- My Participations Section -->
        <section id="my-participations" class="content-section hidden mb-10">
            <header class="mb-6 flex justify-between items-center"><h2 class="text-3xl font-semibold text-gray-800">My Event Participations</h2><button id="refreshMyParticipationBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 flex items-center space-x-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>Refresh Participations</span></button></header>
            <div id="myParticipationList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <p id="noMyParticipationMessage" class="hidden mt-4 text-gray-600">You haven't participated in any events yet.</p>
        </section>
        <!-- Footer -->
        <footer class="mt-auto pt-8 text-center text-sm text-gray-500">&copy; <span id="currentYear"></span> EventHub Portal Inc. All rights reserved.</footer>
    </main>

    <!-- Event Participation Modal -->
    <div id="eventParticipationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2"> <!-- Reduced mb for tighter header -->
                <h2 class="text-2xl font-semibold text-indigo-700">Event Participation</h2>
                <button id="closeParticipationModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="mb-1 text-md">For: <strong id="modalEventName" class="text-indigo-600">Event Name Here</strong></p>
            <p class="mb-3 text-sm text-gray-600">Subscription Closes: <strong id="modalEventSubscriptionCloseDate" class="text-red-600">Date Here</strong></p>
            <hr class="mb-4">
            
            <form id="participationForm" class="space-y-5">
                <input type="hidden" id="modalEventId" name="eventId">
                <input type="hidden" id="modalCoverChargeType" name="coverChargeType" value="per_head">
                <input type="hidden" id="modalFoodChargeType" name="foodChargeType" value="per_head">
                <input type="hidden" id="modalBaseCoverChargeValue" name="baseCoverChargeValue">
                <input type="hidden" id="modalVegFoodCostValue" name="vegFoodCostValue">
                <input type="hidden" id="modalNonVegFoodCostValue" name="nonVegFoodCostValue">

                <!-- Section 1: Participant Details -->
                <div class="form-section">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">1. Participant Details</h3>
                    <div class="form-grid">
                        <div>
                            <label for="participantName" class="required-asterisk">Full Name</label>
                            <input type="text" id="participantName" name="participantName" required>
                        </div>
                        <div>
                            <label for="towerNumber" class="required-asterisk">Tower Number</label>
                            <select id="towerNumber" name="towerNumber" required>
                                <option value="">Select Tower</option>
                                <option value="Alpine1">Alpine 1</option><option value="Alpine2">Alpine 2</option><option value="Alpine3">Alpine 3</option>
                            </select>
                        </div>
                        <div><label for="wing">Wing</label><select id="wing" name="wing"><option value="NA">N/A</option><option value="Left">Left</option><option value="Right">Right</option></select></div>
                        <div><label for="flatType">Flat Type</label><select id="flatType" name="flatType"><option value="">Select Type</option><option value="A">Type A</option><option value="B">Type B</option><option value="C">Type C</option><option value="D">Type D</option></select></div>
                        <div><label for="floorNumber" class="required-asterisk">Floor Number</label><input type="number" id="floorNumber" name="floorNumber" min="1" max="50" required placeholder="1-50"></div>
                         <div>
                            <label for="participationStatus" class="required-asterisk">Participation Status</label>
                            <select id="participationStatus" name="status" required>
                                <option value="interested">Interested</option>
                                <option value="attending">Attending</option>
                                <option value="not_attending">Not Attending</option>
                            </select>
                        </div>
                         <div>
                            <label for="participantEmail">Email (Optional)</label> 
                            <input type="email" id="participantEmail" name="email">
                        </div>
                    </div>
                </div>

                <!-- Section 2: Food & Headcount -->
                <div class="form-section">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">2. Food & Headcount</h3>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div>
                            <label for="vegHeads">Number of Veg Heads</label>
                            <input type="number" min="0" id="vegHeads" name="vegHeads" value="0" class="payable-calculator-input">
                        </div>
                        <div>
                            <label for="nonVegHeads">Number of Non-Veg Heads</label>
                            <input type="number" min="0" id="nonVegHeads" name="nonVegHeads" value="0" class="payable-calculator-input">
                        </div>
                    </div>
                    <div class="info-box mt-3">
                        <p class="text-sm"><span id="displayVegFoodCostLabel">Veg Food Cost:</span> <span id="displayVegFoodCostValue">₹0.00</span>/head. <span id="displayNonVegFoodCostLabel">Non-Veg Food Cost:</span> <span id="displayNonVegFoodCostValue">₹0.00</span>/head.</p>
                    </div>
                </div>
                
                <!-- Section 3: Charges & Contribution -->
                <div class="form-section">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">3. Charges & Contribution</h3>
                     <div class="bg-gray-50 p-4 rounded-lg space-y-2 mb-4">
                        <div class="summary-item"><span id="displayBaseCoverChargeLabel">Base Cover Charge:</span> <strong id="displayBaseCoverChargeValue">₹0.00</strong></div>
                        <hr>
                        <div class="summary-item"><span>Calculated Cover Charges:</span> <strong id="calculatedCoverChargeComponentDisplay">₹0.00</strong></div>
                        <div class="summary-item"><span>Calculated Food Charges:</span> <strong id="calculatedFoodChargeComponentDisplay">₹0.00</strong></div>
                        <hr>
                        <div class="summary-item text-blue-600"><span>Sub-Total (Cover + Food):</span> <strong id="subTotalChargesDisplay">₹0.00</strong></div>
                    </div>

                    <div>
                        <label for="additionalContribution">Additional Contribution (Optional)</label>
                        <input type="number" step="0.01" min="0" id="additionalContribution" name="additionalContribution" value="0" placeholder="e.g., 100.00" class="payable-calculator-input">
                    </div>
                </div>

                <!-- Section 4: Payment Summary & Recording -->
                <div class="form-section">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">4. Payment Summary</h3>
                    <div class="bg-green-50 p-3 rounded-lg mb-4">
                        <div class="summary-item"><span class="text-lg">Total Amount Due:</span> <strong id="totalPayableDisplay" class="total-payable-display">₹0.00</strong></div>
                    </div>
                    <div>
                        <label for="amountPaidNow" class="required-asterisk">Amount Paying Now</label>
                        <input type="number" step="0.01" min="0" id="amountPaidNow" name="amountPaidNow" required placeholder="Enter amount you are paying now" class="payable-calculator-input">
                    </div>
                     <div class="mt-2 mb-4">
                        <p class="text-sm text-gray-600">Remaining Payable: <strong id="remainingPayableDisplay" class="remaining-payable-display">₹0.00</strong></p>
                    </div>
                    <button type="button" id="razorpayButton" class="w-full mt-2 px-4 py-2.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition duration-150 flex items-center justify-center space-x-2 font-medium">
                        <i data-lucide="credit-card" class="w-5 h-5"></i>
                        <span>Pay with Razorpay (Simulated)</span>
                    </button>
                    <small class="text-xs text-gray-500 mt-1 block text-center">Note: Actual payment integration is simulated. Click "Submit Participation" to record your intent.</small>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancelParticipationBtn" class="px-5 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center space-x-2 font-medium">
                        <i data-lucide="send" class="w-5 h-5"></i> <span>Submit Participation</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Message Container -->
    <div id="toastContainer" class="toast-container"></div>
    <script>
        // static/script.js for Enhanced User Portal

        document.addEventListener('DOMContentLoaded', () => {
            const bodyElement = document.body;
            const userId = bodyElement.dataset.userId;

            if (!userId) {
                showToast('Error: User ID not found. Portal cannot be initialized.', 'error');
                console.error('User ID is missing from body data attribute.');
                return;
            }
            console.log(`Portal initialized for User ID: ${userId}`);

            // --- DOM Elements ---
            const profileDisplay = document.getElementById('profileDisplay');
            const profileUsernameSpan = document.getElementById('profileUsername');
            const profileEmailSpan = document.getElementById('profileEmail');
            const profileBioSpan = document.getElementById('profileBio'); 
            const editProfileBtn = document.getElementById('editProfileBtn'); 
            const profileEditForm = document.getElementById('profileEditForm'); 

            const sidebarUserAvatar = document.getElementById('sidebarUserAvatar');
            const sidebarUsername = document.getElementById('sidebarUsername');
            const sidebarUserEmail = document.getElementById('sidebarUserEmail');
            const logoutButton = document.getElementById('logoutButton');

            const allEventsListDiv = document.getElementById('allEventsList');
            const noAllEventsMessage = document.getElementById('noAllEventsMessage');
            const refreshAllEventsBtn = document.getElementById('refreshAllEventsBtn');
            const myParticipationListDiv = document.getElementById('myParticipationList');
            const noMyParticipationMessage = document.getElementById('noMyParticipationMessage');
            const refreshMyParticipationBtn = document.getElementById('refreshMyParticipationBtn');
            
            const eventParticipationModal = document.getElementById('eventParticipationModal');
            const closeParticipationModalBtn = document.getElementById('closeParticipationModalBtn');
            const participationForm = document.getElementById('participationForm');
            const modalEventNameSpan = document.getElementById('modalEventName');
            const modalEventSubscriptionCloseDateSpan = document.getElementById('modalEventSubscriptionCloseDate'); // New
            const modalEventIdInput = document.getElementById('modalEventId');
            
            const modalCoverChargeTypeInput = document.getElementById('modalCoverChargeType');
            const modalFoodChargeTypeInput = document.getElementById('modalFoodChargeType');
            const modalBaseCoverChargeValueInput = document.getElementById('modalBaseCoverChargeValue');
            const modalVegFoodCostValueInput = document.getElementById('modalVegFoodCostValue');
            const modalNonVegFoodCostValueInput = document.getElementById('modalNonVegFoodCostValue');

            const displayBaseCoverChargeLabel = document.getElementById('displayBaseCoverChargeLabel');
            const displayBaseCoverChargeValue = document.getElementById('displayBaseCoverChargeValue');
            const displayVegFoodCostLabel = document.getElementById('displayVegFoodCostLabel');
            const displayVegFoodCostValue = document.getElementById('displayVegFoodCostValue');
            const displayNonVegFoodCostLabel = document.getElementById('displayNonVegFoodCostLabel');
            const displayNonVegFoodCostValue = document.getElementById('displayNonVegFoodCostValue');

            const calculatedCoverChargeComponentDisplay = document.getElementById('calculatedCoverChargeComponentDisplay');
            const calculatedFoodChargeComponentDisplay = document.getElementById('calculatedFoodChargeComponentDisplay');
            const subTotalChargesDisplay = document.getElementById('subTotalChargesDisplay');
            const totalPayableDisplay = document.getElementById('totalPayableDisplay');
            const remainingPayableDisplay = document.getElementById('remainingPayableDisplay'); // New

            const participantNameInput = document.getElementById('participantName');
            const participantEmailInput = document.getElementById('participantEmail'); 
            const towerNumberSelect = document.getElementById('towerNumber');
            const wingSelect = document.getElementById('wing');
            const flatTypeSelect = document.getElementById('flatType');
            const floorNumberInput = document.getElementById('floorNumber');
            const vegHeadsInput = document.getElementById('vegHeads');
            const nonVegHeadsInput = document.getElementById('nonVegHeads');
            const additionalContributionInput = document.getElementById('additionalContribution');
            const amountPaidNowInput = document.getElementById('amountPaidNow'); 
            const participationStatusSelect = document.getElementById('participationStatus');
            const cancelParticipationBtn = document.getElementById('cancelParticipationBtn');
            const razorpayButton = document.getElementById('razorpayButton'); // New
            const payableCalculatorInputs = document.querySelectorAll('.payable-calculator-input');

            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.warn('Lucide library not loaded, icons will not be rendered.');
            }

            const API_BASE_URL = ''; 
            let allEventsDataStore = {}; 

            const DEFAULT_VEG_FOOD_COST = 0.00; 
            const DEFAULT_NON_VEG_FOOD_COST = 0.00;
            const CURRENCY_SYMBOL = '₹'; 

            // --- Navigation ---
            function showSection(sectionId) {
                contentSections.forEach(section => section.classList.add('hidden'));
                navLinks.forEach(link => {
                    link.classList.remove('bg-indigo-600', 'text-white');
                    link.classList.add('hover:bg-gray-700');
                });
                const activeSection = document.getElementById(sectionId);
                const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
                if (activeSection) activeSection.classList.remove('hidden');
                if (activeLink) {
                    activeLink.classList.add('bg-indigo-600', 'text-white');
                    activeLink.classList.remove('hover:bg-gray-700');
                }
                window.location.hash = sectionId;
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(link.dataset.section);
                });
            });
            const initialHash = window.location.hash.substring(1);
            if (initialHash && document.getElementById(initialHash)) {
                 showSection(initialHash);
            } else {
                 showSection('all-events'); 
            }

            // --- Profile Section Update (Simplified) ---
            function displaySimplifiedUserProfileInfo(participations) {
                let displayName = `User ${userId}`;
                let displayEmail = 'N/A';
                const defaultAvatarInitial = 'U';

                if (participations && participations.length > 0) {
                    const firstParticipation = participations[0];
                    if (firstParticipation.user_name_display && firstParticipation.user_name_display !== `User ${userId}`) {
                        displayName = firstParticipation.user_name_display;
                    }
                    if (firstParticipation.user_email_display && firstParticipation.user_email_display !== "N/A") {
                        displayEmail = firstParticipation.user_email_display;
                    }
                }
                
                sidebarUsername.textContent = displayName;
                sidebarUserEmail.textContent = displayEmail;
                const initial = displayName.charAt(0).toUpperCase() || defaultAvatarInitial;
                sidebarUserAvatar.src = `https://placehold.co/40x40/A78BFA/FFFFFF?text=${initial}`;

                profileUsernameSpan.textContent = displayName;
                profileEmailSpan.textContent = displayEmail;
                profileBioSpan.textContent = "Profile details are managed by your participation records or a dedicated profile service.";
                
                editProfileBtn.classList.add('hidden'); 
                profileEditForm.classList.add('hidden');
            }

            // --- API Functions ---
            async function fetchAllEvents() {
                try {
                    const response = await fetch(`${API_BASE_URL}/user_portal/events`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const events = await response.json();
                    allEventsDataStore = events.reduce((acc, event) => {
                        acc[event.id] = event;
                        return acc;
                    }, {});
                    displayAllEvents(events);
                } catch (error) {
                    console.error('Error fetching all events:', error);
                    showToast('Failed to load events.', 'error');
                    allEventsListDiv.innerHTML = '';
                    noAllEventsMessage.classList.remove('hidden');
                    noAllEventsMessage.textContent = 'Could not load events. Please try again.';
                }
            }

            async function fetchMyParticipations() {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}/participation`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const participations = await response.json();
                    displayMyParticipations(participations);
                    displaySimplifiedUserProfileInfo(participations); 
                } catch (error) {
                    console.error('Error fetching my participations:', error);
                    showToast('Failed to load your participations.', 'error');
                    myParticipationListDiv.innerHTML = '';
                    noMyParticipationMessage.classList.remove('hidden');
                    noMyParticipationMessage.textContent = 'Could not load your participations. Try again.';
                    displaySimplifiedUserProfileInfo([]); 
                }
            }
            
            async function submitParticipation(eventId, participationData) {
                const endpoint = `${API_BASE_URL}/users/${userId}/participation/${eventId}`;
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(participationData)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status} - ${errorData.details || ''}`);
                    }
                    const data = await response.json();
                    showToast(data.message || 'Participation submitted successfully!', 'success');
                    closeParticipationModal();
                    fetchMyParticipations(); 
                    fetchAllEvents(); 
                } catch (error) {
                    console.error('Error submitting participation:', error);
                    showToast(`Failed to submit participation: ${error.message}`, 'error');
                }
            }

            // --- Display Functions ---
            function displayAllEvents(events) {
                allEventsListDiv.innerHTML = ''; 
                if (!events || events.length === 0) {
                    noAllEventsMessage.classList.remove('hidden');
                    noAllEventsMessage.textContent = 'No upcoming events found.';
                    return;
                }
                noAllEventsMessage.classList.add('hidden');

                events.forEach(event => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 flex flex-col';
                    
                    const coverChargesValue = event.subscription?.coverCharges || 0;
                    const coverChargesType = event.subscription?.coverChargesType || "per_head";
                    let baseCoverDisplay = 'Free or TBD';
                    if (coverChargesValue > 0) {
                        baseCoverDisplay = coverChargesType === "per_head"
                                            ? `${CURRENCY_SYMBOL}${parseFloat(coverChargesValue).toFixed(2)}/head`
                                            : `${CURRENCY_SYMBOL}${parseFloat(coverChargesValue).toFixed(2)}/${coverChargesType.replace('_', ' ')}`;
                    }
                    
                    const eventDateStr = event.time || event.date; // From Event MS
                    const eventDateDisplay = eventDateStr ? new Date(eventDateStr).toLocaleDateString() : 'Date TBD';
                    
                    const closeDateStr = event.close_date_str || event.close_date; // From Event MS
                    const closeDateDisplay = closeDateStr ? new Date(closeDateStr).toLocaleDateString() : 'N/A';

                    const eventLocationDisplay = event.venue || event.location || 'Location TBD';
                    const eventDescription = event.details || event.description || 'No description available.';

                    card.innerHTML = `
                        <h3 class="text-xl font-semibold text-indigo-700 mb-2">${event.name || 'Unnamed Event'}</h3>
                        <p class="text-sm text-gray-500 mb-1 flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-2"></i>Event Date: ${eventDateDisplay}</p>
                        <p class="text-sm text-red-500 mb-1 flex items-center"><i data-lucide="calendar-x" class="w-4 h-4 mr-2"></i>Ends: ${closeDateDisplay}</p>
                        <p class="text-sm text-gray-500 mb-3 flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>${eventLocationDisplay}</p>
                        <p class="text-gray-600 text-sm mb-4 flex-grow">${eventDescription.substring(0,100)}${eventDescription.length > 100 ? '...' : ''}</p>
                        <p class="text-sm text-gray-700 font-medium mb-3">Cover: ${baseCoverDisplay}</p>
                        <button data-event-id="${event.id}" class="register-event-btn mt-auto w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150 text-sm flex items-center justify-center space-x-2">
                            <i data-lucide="edit" class="w-4 h-4"></i><span>Register / View Status</span>
                        </button>
                    `;
                    allEventsListDiv.appendChild(card);
                });
                if (typeof lucide !== 'undefined') lucide.createIcons(); 

                document.querySelectorAll('.register-event-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const eventId = button.dataset.eventId;
                        openParticipationModal(eventId); 
                    });
                });
            }
            
            function displayMyParticipations(participations) {
                myParticipationListDiv.innerHTML = '';
                if (!participations || participations.length === 0) {
                    noMyParticipationMessage.classList.remove('hidden');
                    noMyParticipationMessage.textContent = "You haven't participated in any events yet.";
                    return;
                }
                noMyParticipationMessage.classList.add('hidden');

                participations.forEach(p_record => { 
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-xl shadow-lg flex flex-col';
                    let statusColor = 'text-gray-500', statusBg = 'bg-gray-100';
                    if (p_record.user_status === 'attending') { statusColor = 'text-green-700'; statusBg = 'bg-green-100'; }
                    else if (p_record.user_status === 'interested') { statusColor = 'text-blue-700'; statusBg = 'bg-blue-100'; }
                    else if (p_record.user_status === 'not_attending') { statusColor = 'text-red-700'; statusBg = 'bg-red-100';}
                    
                    let baseCoverDisplay = 'Free or TBD';
                    if (p_record.base_cover_charge_per_head && p_record.base_cover_charge_per_head > 0) {
                         baseCoverDisplay = `${CURRENCY_SYMBOL}${parseFloat(p_record.base_cover_charge_per_head).toFixed(2)}/head`;
                    } else { 
                        const originalEvent = allEventsDataStore[p_record.event_id];
                        if (originalEvent && originalEvent.subscription) {
                            const coverChargesValue = originalEvent.subscription.coverCharges || 0;
                            const coverChargesType = originalEvent.subscription.coverChargesType || "per_head";
                             if (coverChargesValue > 0) {
                                baseCoverDisplay = coverChargesType === "per_head"
                                                    ? `${CURRENCY_SYMBOL}${parseFloat(coverChargesValue).toFixed(2)}/head`
                                                    : `${CURRENCY_SYMBOL}${parseFloat(coverChargesValue).toFixed(2)}/${coverChargesType.replace('_', ' ')}`;
                            }
                        }
                    }

                    card.innerHTML = `
                        <h3 class="text-xl font-semibold text-indigo-700 mb-2">${p_record.name || 'Unnamed Event'}</h3>
                        <p class="text-sm text-gray-500 mb-1 flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-2"></i>${p_record.date ? new Date(p_record.date).toLocaleDateString() : 'Date TBD'}</p>
                        <p class="text-sm text-gray-500 mb-3 flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>${p_record.location || 'Location TBD'}</p>
                        <p class="text-gray-600 text-sm mb-4 flex-grow">${(p_record.description || 'No description.').substring(0,100)}${(p_record.description && p_record.description.length > 100) ? '...' : ''}</p>
                        <p class="text-sm text-gray-700 font-medium mb-1">Cover: ${baseCoverDisplay}</p>
                        <div class="mb-3">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor} ${statusBg}">${p_record.user_status ? p_record.user_status.charAt(0).toUpperCase() + p_record.user_status.slice(1) : 'N/A'}</span>
                        </div>
                         <button data-event-id="${p_record.event_id}" class="update-participation-btn mt-auto w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition duration-150 text-sm flex items-center justify-center space-x-2">
                            <i data-lucide="edit-2" class="w-4 h-4"></i><span>Update Status</span>
                        </button>
                    `;
                    myParticipationListDiv.appendChild(card);
                });
                if (typeof lucide !== 'undefined') lucide.createIcons();

                document.querySelectorAll('.update-participation-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const eventId = button.dataset.eventId;
                        openParticipationModal(eventId, true /* isUpdate */);
                    });
                });
            }

            // --- Event Handlers ---
            if(editProfileBtn) { 
                editProfileBtn.addEventListener('click', () => { 
                    showToast("User profile management is handled by a dedicated service or via participation records.", "info");
                });
            }

            refreshAllEventsBtn.addEventListener('click', fetchAllEvents);
            refreshMyParticipationBtn.addEventListener('click', fetchMyParticipations);
            logoutButton.addEventListener('click', () => { 
                showCustomConfirm("Are you sure you want to logout?", () => { 
                    showToast("Logged out (simulated). Implement actual logout via auth service.", "info"); 
                }); 
            });

            // --- Participation Modal Logic ---
            function updatePayableAmount() {
                const coverChargeType = modalCoverChargeTypeInput.value;
                const foodChargeType = modalFoodChargeTypeInput.value;
                
                const baseCoverValue = parseFloat(modalBaseCoverChargeValueInput.value) || 0;
                const vegCostValue = parseFloat(modalVegFoodCostValueInput.value) || 0;
                const nonVegCostValue = parseFloat(modalNonVegFoodCostValueInput.value) || 0;

                const numVeg = parseInt(vegHeadsInput.value) || 0;
                const numNonVeg = parseInt(nonVegHeadsInput.value) || 0;
                const totalHeads = numVeg + numNonVeg;

                let calculatedCover = 0;
                if (coverChargeType === 'per_family') {
                    calculatedCover = totalHeads > 0 ? baseCoverValue : 0; 
                } else { // per_head or default
                    calculatedCover = totalHeads * baseCoverValue;
                }

                let calculatedFood = 0;
                if (foodChargeType === 'per_family') {
                    if (numVeg > 0 && vegCostValue > 0) calculatedFood = vegCostValue; 
                    else if (numNonVeg > 0 && nonVegCostValue > 0) calculatedFood = nonVegCostValue; 
                    else if (totalHeads > 0 && vegCostValue > 0) calculatedFood = vegCostValue; 
                } else { 
                    calculatedFood = (numVeg * vegCostValue) + (numNonVeg * nonVegCostValue);
                }
                
                const additionalContrib = parseFloat(additionalContributionInput.value) || 0;
                const subTotal = calculatedCover + calculatedFood;
                const totalAmountDue = subTotal + additionalContrib;
                
                const amountPaid = parseFloat(amountPaidNowInput.value) || 0;
                const remainingPayable = totalAmountDue - amountPaid;

                calculatedCoverChargeComponentDisplay.textContent = `${CURRENCY_SYMBOL}${calculatedCover.toFixed(2)}`;
                calculatedFoodChargeComponentDisplay.textContent = `${CURRENCY_SYMBOL}${calculatedFood.toFixed(2)}`;
                subTotalChargesDisplay.textContent = `${CURRENCY_SYMBOL}${subTotal.toFixed(2)}`;
                totalPayableDisplay.textContent = `${CURRENCY_SYMBOL}${totalAmountDue.toFixed(2)}`;
                remainingPayableDisplay.textContent = `${CURRENCY_SYMBOL}${remainingPayable.toFixed(2)}`;
            }

            payableCalculatorInputs.forEach(input => { // This includes amountPaidNowInput
                input.addEventListener('input', updatePayableAmount);
            });
            
            async function openParticipationModal(eventId, isUpdate = false) {
                const eventDetails = allEventsDataStore[eventId];
                console.log("DEBUG: Opening modal for eventDetails:", JSON.stringify(eventDetails, null, 2)); 
                if (!eventDetails) {
                    showToast(`Event details not found for ID: ${eventId}. Please refresh events.`, 'error');
                    return;
                }

                modalEventIdInput.value = eventId;
                modalEventNameSpan.textContent = eventDetails.name || 'Unnamed Event';
                
                const closeDateStr = eventDetails.close_date_str || eventDetails.close_date;
                modalEventSubscriptionCloseDateSpan.textContent = closeDateStr ? new Date(closeDateStr).toLocaleDateString() : 'N/A';


                const rawCoverCharge = parseFloat(eventDetails.subscription?.coverCharges || 0);
                const coverType = eventDetails.subscription?.coverChargesType || 'per_head';
                
                const rawFoodCharge = parseFloat(eventDetails.food?.foodCharges || 0);
                const foodTypeFromEvent = eventDetails.food?.foodType || 'veg'; 
                const foodChargeTypeFromEvent = eventDetails.food?.foodChargesType || 'per_head';

                modalCoverChargeTypeInput.value = coverType;
                modalFoodChargeTypeInput.value = foodChargeTypeFromEvent;
                modalBaseCoverChargeValueInput.value = rawCoverCharge;
                
                displayBaseCoverChargeLabel.textContent = `Base Cover Charge (${coverType.replace('_', ' ')}):`;
                displayBaseCoverChargeValue.textContent = `${CURRENCY_SYMBOL}${rawCoverCharge.toFixed(2)}`;

                let vegCostForCalc = DEFAULT_VEG_FOOD_COST;
                let nonVegCostForCalc = DEFAULT_NON_VEG_FOOD_COST;

                if (foodChargeTypeFromEvent === 'per_head') {
                    displayVegFoodCostLabel.textContent = `Veg Food Cost:`;
                    displayNonVegFoodCostLabel.textContent = `Non-Veg Food Cost:`;
                    if (foodTypeFromEvent === 'veg') {
                        vegCostForCalc = rawFoodCharge > 0 ? rawFoodCharge : DEFAULT_VEG_FOOD_COST;
                    } else if (foodTypeFromEvent === 'non_veg') {
                        nonVegCostForCalc = rawFoodCharge > 0 ? rawFoodCharge : DEFAULT_NON_VEG_FOOD_COST;
                    } else if (foodTypeFromEvent === 'both') { 
                        if (rawFoodCharge > 0) {
                            vegCostForCalc = rawFoodCharge;
                            nonVegCostForCalc = rawFoodCharge;
                        }
                    }
                } else { 
                    if (foodTypeFromEvent === 'veg') {
                        displayVegFoodCostLabel.textContent = `Veg Food (Family):`;
                        vegCostForCalc = rawFoodCharge > 0 ? rawFoodCharge : DEFAULT_VEG_FOOD_COST;
                        displayNonVegFoodCostLabel.textContent = `Non-Veg Food:`; 
                        nonVegCostForCalc = 0; 
                    } else if (foodTypeFromEvent === 'non_veg') {
                        displayNonVegFoodCostLabel.textContent = `Non-Veg Food (Family):`;
                        nonVegCostForCalc = rawFoodCharge > 0 ? rawFoodCharge : DEFAULT_NON_VEG_FOOD_COST;
                        displayVegFoodCostLabel.textContent = `Veg Food:`;
                        vegCostForCalc = 0;
                    } else if (foodTypeFromEvent === 'both') {
                        displayVegFoodCostLabel.textContent = `Food (Family - Veg/Non-Veg):`;
                        vegCostForCalc = rawFoodCharge > 0 ? rawFoodCharge : (DEFAULT_VEG_FOOD_COST || DEFAULT_NON_VEG_FOOD_COST) ; 
                        nonVegCostForCalc = 0; 
                        displayNonVegFoodCostValue.textContent = `N/A`; 
                    }
                }
                
                modalVegFoodCostValueInput.value = vegCostForCalc;
                modalNonVegFoodCostValueInput.value = nonVegCostForCalc;

                displayVegFoodCostValue.textContent = `${CURRENCY_SYMBOL}${vegCostForCalc.toFixed(2)}${foodChargeTypeFromEvent === 'per_head' ? '/head' : (vegCostForCalc > 0 ? '/family' : '')}`;
                displayNonVegFoodCostValue.textContent = `${CURRENCY_SYMBOL}${nonVegCostForCalc.toFixed(2)}${foodChargeTypeFromEvent === 'per_head' ? '/head' : (nonVegCostForCalc > 0 ? '/family' : '')}`;
                if(foodChargeTypeFromEvent === 'per_family' && foodTypeFromEvent === 'both' && rawFoodCharge > 0) {
                     displayNonVegFoodCostValue.textContent = `(Included)`; 
                } else if (foodChargeTypeFromEvent === 'per_family' && foodTypeFromEvent === 'veg' && rawFoodCharge > 0) {
                    displayNonVegFoodCostValue.textContent = `N/A`;
                } else if (foodChargeTypeFromEvent === 'per_family' && foodTypeFromEvent === 'non_veg' && rawFoodCharge > 0) {
                    displayVegFoodCostValue.textContent = `N/A`;
                }

                participationForm.reset(); 
                modalEventIdInput.value = eventId; 
                modalCoverChargeTypeInput.value = coverType;
                modalFoodChargeTypeInput.value = foodChargeTypeFromEvent;
                modalBaseCoverChargeValueInput.value = rawCoverCharge;
                modalVegFoodCostValueInput.value = vegCostForCalc; 
                modalNonVegFoodCostValueInput.value = nonVegCostForCalc;

                participantNameInput.value = sidebarUsername.textContent !== `User ${userId}` ? sidebarUsername.textContent : '';
                participantEmailInput.value = sidebarUserEmail.textContent !== 'N/A' ? sidebarUserEmail.textContent : '';
                
                if (isUpdate) {
                    showToast("Fetching your existing participation details...", "info");
                    try {
                        const response = await fetch(`${API_BASE_URL}/users/${userId}/participation/${eventId}`); 
                        if (!response.ok) {
                            if (response.status === 404) {
                                showToast("No prior participation found. Please fill as new.", "info");
                                vegHeadsInput.value = '0'; nonVegHeadsInput.value = '0';
                                additionalContributionInput.value = '0'; amountPaidNowInput.value = '0';
                                participationStatusSelect.value = 'interested';
                            } else { throw new Error(`Failed to fetch existing participation: ${response.status}`); }
                        } else {
                            const existingParticipation = await response.json();
                            const p_details = existingParticipation.details_from_participation_service || existingParticipation.details || existingParticipation;

                            participantNameInput.value = p_details.participantName || p_details.user_name || sidebarUsername.textContent || '';
                            participantEmailInput.value = p_details.email_id || sidebarUserEmail.textContent || '';
                            towerNumberSelect.value = p_details.towerNumber || p_details.tower_number || '';
                            wingSelect.value = p_details.wing || 'NA';
                            flatTypeSelect.value = p_details.flatType || p_details.flat_type || '';
                            floorNumberInput.value = p_details.floorNumber || p_details.floor_number || '';
                            vegHeadsInput.value = p_details.vegHeads || p_details.veg_heads || '0';
                            nonVegHeadsInput.value = p_details.nonVegHeads || p_details.non_veg_heads || '0';
                            additionalContributionInput.value = p_details.additionalContribution || p_details.additional_contribution_amount || '0';
                            amountPaidNowInput.value = p_details.coverChargePaid || p_details.cover_charge_paid_amount || '0'; 
                            participationStatusSelect.value = existingParticipation.user_status || existingParticipation.status || 'interested';
                        }
                    } catch (err) {
                        console.error("Error fetching existing participation:", err);
                        showToast("Could not fetch existing participation. Please fill manually.", "error");
                        amountPaidNowInput.value = '0';
                        participationStatusSelect.value = 'interested';
                    }
                } else { 
                    vegHeadsInput.value = '0';
                    nonVegHeadsInput.value = '0';
                    additionalContributionInput.value = '0';
                    amountPaidNowInput.value = '0'; 
                    participationStatusSelect.value = 'attending'; 
                }
                
                updatePayableAmount(); 
                eventParticipationModal.classList.add('active');
            }

            function closeParticipationModal() {
                eventParticipationModal.classList.remove('active');
            }

            closeParticipationModalBtn.addEventListener('click', closeParticipationModal);
            cancelParticipationBtn.addEventListener('click', closeParticipationModal);
            eventParticipationModal.addEventListener('click', (e) => { if (e.target === eventParticipationModal) closeParticipationModal(); });

            razorpayButton.addEventListener('click', () => {
                const amountToPay = parseFloat(amountPaidNowInput.value);
                const totalDue = parseFloat(totalPayableDisplay.textContent.replace(CURRENCY_SYMBOL, ''));

                if (isNaN(amountToPay) || amountToPay <= 0) {
                    showToast("Please enter a valid amount to pay.", "error");
                    amountPaidNowInput.focus();
                    return;
                }
                if (amountToPay > totalDue) {
                    showToast(`Amount to pay (${CURRENCY_SYMBOL}${amountToPay.toFixed(2)}) cannot exceed total due (${CURRENCY_SYMBOL}${totalDue.toFixed(2)}).`, "error");
                    amountPaidNowInput.focus();
                    return;
                }
                // Simulate Razorpay redirection
                showToast(`Simulating Razorpay payment for ${CURRENCY_SYMBOL}${amountToPay.toFixed(2)}...`, "info");
                // In a real scenario, you would call your backend here to create a Razorpay order,
                // then use Razorpay's checkout.js with the order_id.
                // For example:
                // 1. Fetch call to your backend: POST /create_razorpay_order { amount: amountToPay }
                // 2. Backend creates order with Razorpay API, returns order_id.
                // 3. Frontend initializes Razorpay checkout with that order_id.
                // After successful payment, Razorpay calls a handler where you would typically
                // then call the submitParticipation() function or a dedicated "recordPayment" function.
                console.log("Simulated Razorpay: User intends to pay:", amountToPay);
            });

            participationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const eventId = modalEventIdInput.value;
                const totalDue = parseFloat(totalPayableDisplay.textContent.replace(CURRENCY_SYMBOL, ''));
                const amountBeingPaid = parseFloat(amountPaidNowInput.value);

                if (isNaN(amountBeingPaid)) {
                    showToast("Invalid amount entered for payment.", "error");
                    amountPaidNowInput.focus();
                    return;
                }
                 if (amountBeingPaid > totalDue && totalDue > 0) { // Allow 0 if total is 0
                    showToast(`Amount paid (${CURRENCY_SYMBOL}${amountBeingPaid.toFixed(2)}) cannot exceed total due (${CURRENCY_SYMBOL}${totalDue.toFixed(2)}).`, "error");
                    amountPaidNowInput.focus();
                    return;
                }
                if (amountBeingPaid < 0) {
                    showToast("Amount paid cannot be negative.", "error");
                    amountPaidNowInput.focus();
                    return;
                }


                const participationPayload = {
                    status: participationStatusSelect.value,
                    details: { 
                        participantName: participantNameInput.value, 
                        email: participantEmailInput.value, 
                        towerNumber: towerNumberSelect.value,
                        wing: wingSelect.value,
                        flatType: flatTypeSelect.value,
                        floorNumber: parseInt(floorNumberInput.value),
                        // Backend should use this as `cover_charge_paid_amount`
                        coverChargePaid: amountBeingPaid, 
                        additionalContribution: parseFloat(additionalContributionInput.value || 0),
                        vegHeads: parseInt(vegHeadsInput.value || 0),
                        nonVegHeads: parseInt(nonVegHeadsInput.value || 0)
                    }
                };
                submitParticipation(eventId, participationPayload);
            });

            // --- Utility Functions (Toast and Confirm) ---
            const toastContainer = document.getElementById('toastContainer');
            function showToast(message, type = 'info', duration = 3000) {
                if (!toastContainer) {
                    console.warn("Toast container not found. Cannot display toast:", message);
                    return;
                }
                const toast = document.createElement('div');
                toast.className = `toast-message ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'toast-out 0.5s forwards';
                    toast.addEventListener('animationend', () => toast.remove());
                }, duration);
            }
            function showCustomConfirm(message, onConfirm, onCancel) {
                const overlayId = 'custom-confirm-overlay';
                if (document.getElementById(overlayId)) return;
                const overlay = document.createElement('div');
                overlay.id = overlayId;
                overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[9999]'; 
                const dialog = document.createElement('div');
                dialog.className = 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full';
                const messageP = document.createElement('p');
                messageP.className = 'text-lg text-gray-700 mb-6';
                messageP.textContent = message;
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-end space-x-3';
                const confirmButton = document.createElement('button');
                confirmButton.className = 'px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition';
                confirmButton.textContent = 'Confirm';
                confirmButton.onclick = () => { overlay.remove(); if (onConfirm) onConfirm(); };
                const cancelButton = document.createElement('button');
                cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition';
                cancelButton.textContent = 'Cancel';
                cancelButton.onclick = () => { overlay.remove(); if (onCancel) onCancel(); };
                buttonContainer.appendChild(cancelButton); buttonContainer.appendChild(confirmButton);
                dialog.appendChild(messageP); dialog.appendChild(buttonContainer);
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
            }

            // --- Initial Load ---
            async function initializePortal() {
                await fetchAllEvents();
                await fetchMyParticipations(); 
            }

            initializePortal();

        }); // End DOMContentLoaded
    </script>
</body>
</html>
